# Plugins

Extend FluxMedia with custom functionality using the plugin system.

## Overview

Plugins can hook into various lifecycle stages:

- **beforeUpload** - Modify file/options before upload
- **afterUpload** - Modify result after upload
- **onError** - Handle upload errors
- **beforeDelete** - Modify ID before deletion
- **afterDelete** - Run code after deletion
- **beforeGetUrl** - Modify URL generation

## Creating a Plugin

```typescript
import { createPlugin } from '@fluxmedia/core';

const loggerPlugin = createPlugin('logger', {
  beforeUpload: async (file, options) => {
    console.log('Uploading:', file);
    return { file, options };
  },
  afterUpload: async (result) => {
    console.log('Uploaded:', result.url);
    return result;
  },
  onError: async (error, context) => {
    console.error('Failed:', error.message);
  },
});
```

## Registering Plugins

```typescript
const uploader = new MediaUploader(provider);

// Register a single plugin
await uploader.use(loggerPlugin);

// Or chain multiple
await uploader
  .use(loggerPlugin)
  .use(validationPlugin)
  .use(compressionPlugin);

// Or pass plugins in constructor
const uploader = new MediaUploader(provider, [
  loggerPlugin,
  validationPlugin,
]);
```

## Plugin Override Behavior

When registering plugins with the same name, **the last one wins**:

```typescript
// First version
await uploader.use(createPlugin('analytics', {
  afterUpload: async (result) => {
    sendToAnalytics('v1', result);
    return result;
  },
}));

// Override with new version
await uploader.use(createPlugin('analytics', {
  afterUpload: async (result) => {
    sendToAnalytics('v2', result); // This one runs
    return result;
  },
}));

// Only v2 analytics runs - v1 was replaced
```

## Plugin Examples

### Validation Plugin

```typescript
const validationPlugin = createPlugin('validation', {
  beforeUpload: async (file, options) => {
    const maxSize = 10 * 1024 * 1024; // 10MB
    
    if (file instanceof Buffer && file.length > maxSize) {
      throw new Error(`File too large (max ${maxSize} bytes)`);
    }
    
    if (file instanceof File && file.size > maxSize) {
      throw new Error(`File too large (max ${maxSize} bytes)`);
    }
    
    return { file, options };
  },
});
```

### Auto-Folder Plugin

```typescript
const autoFolderPlugin = createPlugin('auto-folder', {
  beforeUpload: async (file, options) => {
    const date = new Date();
    const folder = `${date.getFullYear()}/${date.getMonth() + 1}`;
    
    return {
      file,
      options: { ...options, folder },
    };
  },
});
```

### Metadata Enrichment Plugin

```typescript
const metadataPlugin = createPlugin('metadata', {
  afterUpload: async (result) => {
    return {
      ...result,
      metadata: {
        ...result.metadata,
        uploadedAt: new Date().toISOString(),
        uploadedBy: getCurrentUser().id,
      },
    };
  },
});
```

## Plugin Lifecycle

```typescript
interface FluxMediaPlugin {
  name: string;
  version?: string;
  hooks: PluginHooks;
  init?: () => Promise<void> | void;    // Called on register
  destroy?: () => Promise<void> | void; // Called on unregister/override
}
```

## Plugin Manager API

Access the plugin manager directly:

```typescript
// Check if plugin exists
uploader.plugins.has('logger');

// Get a plugin
const plugin = uploader.plugins.get('logger');

// Unregister
await uploader.plugins.unregister('logger');

// Get all plugins
const allPlugins = uploader.plugins.getAll();

// Clear all
await uploader.plugins.clear();
```
